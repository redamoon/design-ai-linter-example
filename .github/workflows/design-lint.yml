name: Design AI Linter

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  lint:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: pnpmã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pnpm install

      - name: ãƒ¬ãƒãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
        run: mkdir -p reports

      - name: design-ai-linterã®å®Ÿè¡Œ
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # æ¨™æº–å‡ºåŠ›ã¨ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã®ä¸¡æ–¹ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
          pnpm exec dslint lint --model gemini-2.5-flash --pr-comment > reports/lint-report.md 2>&1 || true
          exit_code=$?
          
          # ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
          if [ ! -f reports/lint-report.md ]; then
            echo "âš ï¸ ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" > reports/lint-report.md
          fi
          
          # JSONå½¢å¼ã®ãƒ¬ãƒãƒ¼ãƒˆã‚‚ç¢ºèªï¼ˆdesignlintrc.jsonã§è¨­å®šæ¸ˆã¿ï¼‰
          if [ ! -f reports/lint-report.json ]; then
            echo "{}" > reports/lint-report.json
          fi
          
          # ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚ç¶šè¡Œã™ã‚‹ãŸã‚ã€exit_codeã¯å¾Œã§ä½¿ç”¨
          echo "exit_code=$exit_code" >> $GITHUB_ENV

      - name: ã‚¨ãƒ©ãƒ¼æƒ…å ±ã®æŠ½å‡ºã¨æ•´å½¢
        if: always()
        run: |
          node .github/scripts/parse-lint-errors.cjs reports reports/pr-comment.md || true
          
      - name: PRã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦ãƒ¬ãƒãƒ¼ãƒˆã‚’æŠ•ç¨¿
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // æ•´å½¢ã•ã‚ŒãŸPRã‚³ãƒ¡ãƒ³ãƒˆç”¨ã®ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚’èª­ã¿è¾¼ã‚€
            const prCommentPath = 'reports/pr-comment.md';
            let commentBody = '';
            
            if (fs.existsSync(prCommentPath)) {
              commentBody = fs.readFileSync(prCommentPath, 'utf8');
            } else {
              // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å…ƒã®ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½¿ç”¨
              const reportPath = 'reports/lint-report.md';
              if (fs.existsSync(reportPath)) {
                const reportContent = fs.readFileSync(reportPath, 'utf8');
                if (reportContent.trim()) {
                  commentBody = `## ğŸ” Design AI Linter Report\n\n${reportContent}`;
                }
              }
            }
            
            // ã‚¨ãƒ©ãƒ¼æƒ…å ±ã®JSONã‚‚èª­ã¿è¾¼ã‚€ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
            let errorInfo = null;
            const errorJsonPath = 'reports/errors.json';
            if (fs.existsSync(errorJsonPath)) {
              try {
                errorInfo = JSON.parse(fs.readFileSync(errorJsonPath, 'utf8'));
              } catch (e) {
                console.log('ã‚¨ãƒ©ãƒ¼æƒ…å ±ã®JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', e.message);
              }
            }
            
            // ã‚³ãƒ¡ãƒ³ãƒˆãŒç©ºã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            if (!commentBody.trim()) {
              console.log('ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ãŒç©ºã®ãŸã‚ã€PRã‚³ãƒ¡ãƒ³ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');
              return;
            }
            
            // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              (comment.body.includes('Design AI Linter Report') || 
               comment.body.includes('Design AI Linter'))
            );
            
            // ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã¾ãŸã¯æ›´æ–°
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
              console.log('PRã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
              console.log('PRã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ');
            }
            
            // ã‚¨ãƒ©ãƒ¼æƒ…å ±ãŒã‚ã‚‹å ´åˆã¯ãƒ­ã‚°ã«å‡ºåŠ›
            if (errorInfo && errorInfo.hasErrors) {
              console.log('ã‚¨ãƒ©ãƒ¼ã‚µãƒãƒªãƒ¼:', JSON.stringify(errorInfo.summary, null, 2));
            }

      - name: ãƒ¬ãƒãƒ¼ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: design-lint-report
          path: |
            reports/lint-report.md
            reports/lint-report.json
            reports/pr-comment.md
            reports/errors.json
          retention-days: 7
          if-no-files-found: warn

